#!/bin/bash

API_URL="https://api.deepseek.com/v1/chat/completions"
MODEL="deepseek-chat"
LOG_DIR="$HOME/.log"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/$(date +%Y-%m-%d_%H-%M-%S).log"

STDIN_CONTENT=""
if [ -p /dev/stdin ]; then
    STDIN_CONTENT=$(cat -)
fi

if [ -z "$*" ] && [ -z "$STDIN_CONTENT" ]; then
    if [ -f "$HOME/.ag-last" ]; then
        cat "$HOME/.ag-last"
    fi
    exit 0
fi

USER_PROMPT="$*"

if [ -n "$VIMRUNTIME" ]; then
    STRICT_FORMAT="[STRICT: Output ONLY raw code. No markdown, no comments, no emojis, no explanations.] "
    USER_PROMPT="${STRICT_FORMAT}${USER_PROMPT}"
fi

FINAL_MESSAGE="${USER_PROMPT}"
if [ -n "$STDIN_CONTENT" ]; then
    FINAL_MESSAGE="${USER_PROMPT}\n\nContext/Input:\n${STDIN_CONTENT}"
fi

echo "--- INPUT ---" > "$LOG_FILE"
echo -e "$FINAL_MESSAGE" >> "$LOG_FILE"
echo -e "\n--- API RESPONSE ---" >> "$LOG_FILE"

PAYLOAD=$(jq -n \
    --arg model "$MODEL" \
    --arg msg "$FINAL_MESSAGE" \
    '{model: $model, messages: [{role: "user", content: $msg}], stream: false}')

RAW_RESPONSE=$(curl -s -X POST "$API_URL" \
     -H 'Content-Type: application/json' \
     -H "Authorization: Bearer ${DEEPSEEK_API_KEY}" \
     -d "$PAYLOAD")

echo "$RAW_RESPONSE" >> "$LOG_FILE"

CLEAN_OUTPUT=$(echo "$RAW_RESPONSE" | jq -r '.choices[0].message.content // .error.message // "Error: No response"')

echo "$CLEAN_OUTPUT" > "$HOME/.ag-last"

if [ -n "$VIMRUNTIME" ]; then
    echo "$CLEAN_OUTPUT"
else
    echo "$CLEAN_OUTPUT" | glow -s dark 2>/dev/null || echo "$CLEAN_OUTPUT"
fi
