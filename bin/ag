#!/usr/bin/env python3

import sys
import os
import json
import subprocess
import re
from pathlib import Path
from datetime import datetime
import requests

# --- 配置区 ---
API_URL = "https://api.deepseek.com/v1/chat/completions"
MODEL = "deepseek-chat"
LOG_DIR = Path.home() / ".log"
LOG_DIR.mkdir(exist_ok=True)
LOG_FILE = LOG_DIR / f"{datetime.now().strftime('%Y-%m-%d_%H-%M-%S')}.log"

def extract_clean_code(text: str) -> str:
    """提取第一个代码块内容，并强制移除末尾残留的反引号"""
    text = text.strip()
    # 尝试提取 ```...``` 内部
    pattern = r"```(?:\w+)?\n(.*?)\n```"
    match = re.search(pattern, text, re.DOTALL)
    
    if match:
        content = match.group(1)
    else:
        # 如果只有开头没有结尾，剥离第一行
        lines = text.splitlines()
        if lines and lines[0].startswith("```"):
            content = "\n".join(lines[1:])
        else:
            content = text

    # 针对你遇到的 return class``` 情况：
    # 移除任何行末及之后出现的反引号
    content = re.sub(r'```.*$', '', content, flags=re.MULTILINE).strip()
    return content

def main():
    output_format = ""
    user_prompt_parts = []
    
    # 1. 参数解析
    args = sys.argv[1:]
    i = 0
    while i < len(args):
        if args[i] == "-o" and i + 1 < len(args):
            output_format = args[i + 1].lower()
            i += 2
        else:
            user_prompt_parts.append(args[i])
            i += 1
    
    user_prompt = " ".join(user_prompt_parts)
    is_vim = "VIMRUNTIME" in os.environ
    last_file = Path.home() / ".ag-last"

    # 2. 读取标准输入
    stdin_content = ""
    if not sys.stdin.isatty():
        stdin_content = sys.stdin.read()

    # 3. 历史记录逻辑 (修复点)
    if not user_prompt and not stdin_content:
        if last_file.exists():
            content = last_file.read_text()
            if output_format or is_vim:
                # 带 -o 或者在 Vim 里，直接输出纯文本
                sys.stdout.write(content)
            else:
                # 否则用 glow
                try:
                    subprocess.run(["glow", "-s", "dark"], input=content.encode(), check=False)
                except FileNotFoundError:
                    print(content)
        return 0

    # 4. API 调用准备
    api_key = os.environ.get("DEEPSEEK_API_KEY")
    if not api_key:
        print("Error: DEEPSEEK_API_KEY not set", file=sys.stderr)
        return 1

    sys_msgs = ["Output ONLY raw code. No explanations."]
    if output_format:
        sys_msgs.append(f"Output valid {output_format} only.")
    
    payload = {
        "model": MODEL,
        "messages": [
            {"role": "system", "content": " ".join(sys_msgs)},
            {"role": "user", "content": f"{user_prompt}\n\n{stdin_content}".strip()}
        ],
        "temperature": 0.1
    }

    try:
        resp = requests.post(API_URL, headers={"Authorization": f"Bearer {api_key}"}, json=payload, timeout=30)
        resp.raise_for_status()
        raw_content = resp.json()["choices"][0]["message"]["content"]
    except Exception as e:
        print(f"API Error: {e}", file=sys.stderr)
        return 1

    # 5. 清洗与校验
    clean_output = extract_clean_code(raw_content)
    
    # 保存记录
    last_file.write_text(clean_output)

    # 6. 最终显示逻辑
    if is_vim or (not sys.stdout.isatty()):
        # Vim 或 管道输出：绝对纯净
        sys.stdout.write(clean_output)
    elif output_format:
        print(clean_output)
    else:
        # 普通 Prompt 输出
        subprocess.run(["glow", "-s", "dark"], input=clean_output.encode(), check=False)

    return 0

if __name__ == "__main__":
    sys.exit(main())
